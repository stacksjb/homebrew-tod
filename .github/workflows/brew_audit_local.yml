name: Brew Audit (Local Repo)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Ref of homebrew-tod to audit (branch, tag, or SHA)"
        type: string
        required: false
        default: "main"
      formula:
        description: "Formula name to audit (e.g., tod)"
        type: string
        required: false
        default: "tod"
      online:
        description: "Run online checks (recommended)"
        type: boolean
        required: false
        default: true

permissions:
  contents: read

concurrency:
  group: brew-audit
  cancel-in-progress: false

jobs:
  audit:
    runs-on: macos-latest   # Homebrew is preinstalled on macOS runners

    steps:
      - name: Create app token (tod-deploy)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.TODD_APP_ID }}
          private-key: ${{ secrets.TODD_PRIVATE_KEY }}
          owner: tod-org
          repositories: homebrew-tod

      - name: Checkout homebrew-tod
        uses: actions/checkout@v4
        with:
          repository: tod-org/homebrew-tod
          ref: ${{ inputs.ref }}
          fetch-depth: 1
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false

      - name: Tap local path & audit
        env:
          HOMEBREW_NO_AUTO_UPDATE: "1"
          HOMEBREW_NO_ANALYTICS: "1"
        run: |
          set -euo pipefail

          RAW_TAP="tod-org/homebrew-tod"
          CANON_TAP="${RAW_TAP/homebrew-/}"   # -> tod-org/tod
          FORMULA="${{ inputs.formula }}"
          ONLINE_FLAG=""
          if [[ "${{ inputs.online }}" == "true" ]]; then
            ONLINE_FLAG="--online"
          fi

          # Tap the local checkout path as the tap; canonical name becomes tod-org/tod
          brew untap "$CANON_TAP" || true
          brew tap "$RAW_TAP" "$(pwd)"

          echo "==> readall"
          brew readall "$CANON_TAP"

          echo "==> style"
          brew style "$CANON_TAP/$FORMULA"

          echo "==> audit --strict $ONLINE_FLAG"
          brew audit --strict $ONLINE_FLAG "$CANON_TAP/$FORMULA"
